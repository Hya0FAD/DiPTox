# DiPTox - è®¡ç®—æ¯’ç†å­¦æ•°æ®æ•´åˆä¸æ¸…æ´—

![PyPI Test Version](https://img.shields.io/badge/testpypi-1.3.4-blue) ![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg) ![Python Version](https://img.shields.io/badge/python-3.8+-brightgreen.svg) [![English](https://img.shields.io/badge/-English-blue.svg)](./README.md)

<p align="center">
  <img src="assets/TOC.png" alt="DiPTox å·¥ä½œæµç¤ºæ„å›¾" width="500">
</p>

**DiPTox** æ˜¯ä¸€ä¸ªä¸“ä¸ºåˆ†å­æ•°æ®é›†çš„ç¨³å¥é¢„å¤„ç†ã€æ ‡å‡†åŒ–åŠå¤šæºæ•°æ®æ•´åˆè€Œè®¾è®¡çš„ Python å·¥å…·åŒ…ï¼Œä¸“æ³¨äºè®¡ç®—æ¯’ç†å­¦å·¥ä½œæµã€‚

## v1.3 æ–°ç‰¹æ€§ï¼š
# âœ¨ æ ¸å¿ƒæ–°åŠŸèƒ½

-   **å•ä½æ ‡å‡†åŒ–ç³»ç»Ÿ**ï¼š
    -   **è‡ªåŠ¨è½¬æ¢**ï¼šå†…ç½®äº†é’ˆå¯¹ **æµ“åº¦**ï¼ˆè´¨é‡/ä½“ç§¯ã€æ‘©å°”ã€æ¯”ä¾‹ï¼‰ã€**æ—¶é—´**ã€**å‹åŠ›** å’Œ **æ¸©åº¦** çš„å¸¸ç”¨è½¬æ¢è§„åˆ™ã€‚
    -   **è‡ªå®šä¹‰å…¬å¼**ï¼šæ”¯æŒé€šè¿‡ GUI æˆ–è„šæœ¬äº¤äº’å¼å®šä¹‰æ•°å­¦è½¬æ¢è§„åˆ™ï¼ˆä¾‹å¦‚ `x * 1000` æˆ– `10**(-x)`ï¼‰ã€‚
    -   **ç»Ÿä¸€åŒ–**ï¼šè½»æ¾å°†å¼‚æ„çš„å®éªŒæ•°æ®æ ‡å‡†åŒ–ä¸ºå•ä¸€ç›®æ ‡å•ä½ã€‚

-   **å…¨æµç¨‹å†å²è¿½è¸ª**ï¼š
    -   å¼•å…¥äº† **å®¡è®¡æ—¥å¿— (Audit Log)** ç³»ç»Ÿï¼Œè‡ªåŠ¨è®°å½•æ¯ä¸ªæ“ä½œï¼ˆåŠ è½½ã€é¢„å¤„ç†ã€è¿‡æ»¤ã€å»é‡ç­‰ï¼‰ã€‚
    -   è¯¦ç»†è¿½è¸ªæ¯ä¸ªé˜¶æ®µçš„ **æ—¶é—´æˆ³**ã€**æ“ä½œè¯¦æƒ…** ä»¥åŠä¿ç•™æˆ–ç§»é™¤çš„è¡Œæ•°å˜åŒ–ï¼ˆ**Delta**ï¼‰ã€‚
    -   è¯¥åŠŸèƒ½åœ¨ Python API (`get_history()`) å’Œ GUI å¯è§†åŒ–ç•Œé¢ä¸­å‡å¯ä½¿ç”¨ã€‚

-   **é«˜çº§å»é‡æ§åˆ¶**ï¼š
    -   **Log å˜æ¢**ï¼šå»é‡æ¨¡å—ç°åœ¨æ”¯æŒé€šè¿‡å•ä¸€å‚æ•°å¯¹ç›®æ ‡å€¼è¿›è¡Œå¯é€‰çš„ `-log10` å˜æ¢ï¼ˆä¾‹å¦‚å°† IC50 è½¬æ¢ä¸º pIC50ï¼‰ã€‚
    -   **çµæ´»çš„ NaN å¤„ç†**ï¼šæ–°å¢æ§åˆ¶é€‰é¡¹ï¼Œå…è®¸ä¿ç•™æ¡ä»¶åˆ—ä¸­å­˜åœ¨ç¼ºå¤±å€¼çš„è¡Œï¼ˆå°† *NaN* è§†ä¸ºä¸€ä¸ªç‹¬ç«‹åˆ†ç»„ï¼‰ï¼Œé˜²æ­¢æ•°æ®æ„å¤–ä¸¢å¤±ã€‚

### ğŸ› ï¸ æ”¹è¿›ä¸ä¿®å¤

-   **æ›´å¥å£®çš„æ•°æ®åŠ è½½ (SDF/MOL/SMI)**ï¼š
    -   **SDF/MOL äºŒè¿›åˆ¶è§£æ**ï¼šåˆ‡æ¢è‡³äºŒè¿›åˆ¶æµè¯»å–æ¨¡å¼ï¼Œè§£å†³ç¼–ç å´©æºƒé—®é¢˜ï¼ˆå¦‚ Windows ç¯å¢ƒä¸‹å¸¸è§çš„ `utf-8` ä¸ `latin-1` è§£ç é”™è¯¯ï¼‰ã€‚
    -   **è‡ªåŠ¨ SMILES ç”Ÿæˆ**ï¼šå¯¹äº SDF/MOL æ–‡ä»¶ï¼Œç»“æ„å—è§£æåˆ†å­å¹¶ç”Ÿæˆ SMILESï¼Œå³ä½¿æ–‡ä»¶å±æ€§ä¸­ç¼ºå°‘å…·ä½“çš„ "SMILES" åˆ—ä¹Ÿèƒ½åŠ è½½ã€‚
    -   **è¡¨å¤´æ§åˆ¶**ï¼šåœ¨ GUI ä¸­ä¸º `.smi` ã€ `.csv` å’Œ `.txt` æ–‡ä»¶æ·»åŠ äº† **"Has Header?"ï¼ˆåŒ…å«è¡¨å¤´ï¼Ÿï¼‰** å¼€å…³ï¼Œæ”¯æŒç²¾ç¡®æ§åˆ¶è§£ææ–¹å¼ã€‚
    -   **æ™ºèƒ½åˆ—æ˜ å°„**ï¼šä¿®å¤äº†åœ¨æ— è¡¨å¤´æ–‡ä»¶ä¸­é€šè¿‡ç´¢å¼•ï¼ˆå¦‚ `0`, `1`ï¼‰æ˜ å°„åˆ—æ—¶å¯èƒ½å¯¼è‡´æ•°æ®è¢«é”™è¯¯è¦†ç›–çš„é€»è¾‘é—®é¢˜ã€‚

-   **å¢å¼ºçš„æ— æœºç‰©è¿‡æ»¤**ï¼š
    -   å‡çº§ `remove_inorganic` æ¨¡å—ï¼Œé‡‡ç”¨ä¸¥æ ¼çš„ SMARTS æ¨¡å¼åŒ¹é…ã€‚
    -   ç°åœ¨èƒ½å‡†ç¡®è¯†åˆ«å¹¶ç§»é™¤å¤æ‚çš„æ— æœºç‰©è´¨ï¼ˆå¦‚ç¦»å­æ°°åŒ–ç‰© `[C-]#N`ã€ç¢³é…¸ç›ã€ç¾°åŸºï¼‰ï¼ŒåŒæ—¶é¿å…å°†æœ‰æœºç»“æ„ï¼ˆå¦‚è…ˆç±»ï¼‰è¯¯åˆ¤ä¸ºæ— æœºç‰©ã€‚

-   **GUI ä½“éªŒä¼˜åŒ–**ï¼š
    -   ä¼˜åŒ–äº†â€œæ–‡ä»¶ä¸Šä¼ â€å·¥ä½œæµï¼Œå¢åŠ äº†ç‰¹å®šæ–‡ä»¶ç±»å‹çš„æ™ºèƒ½æç¤ºï¼ˆä¾‹å¦‚ SDF è‡ªåŠ¨è§£ææç¤ºï¼‰ã€‚
    -   åˆ—é€‰æ‹©é€»è¾‘ç°åœ¨ä¼šæ ¹æ®æ–‡ä»¶æ˜¯å¦æœ‰è¡¨å¤´è¿›è¡Œå®æ—¶æ›´æ–°ã€‚

## DiPTox ç¤¾åŒºç™»è®° (å¯é€‰)
ä¸ºäº†æ›´å¥½åœ°äº†è§£ç”¨æˆ·ç¾¤ä½“å¹¶æ”¹è¿›è½¯ä»¶ï¼ŒDiPTox åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šæä¾›ä¸€ä¸ªä¸€æ¬¡æ€§çš„ã€å¯é€‰çš„ç”¨æˆ·ä¿¡æ¯ç™»è®°ã€‚
-   **å®Œå…¨è‡ªæ„¿**ï¼šæ‚¨åªéœ€ç‚¹å‡»ä¸€ä¸‹å³å¯è·³è¿‡ã€‚
-   **æ³¨é‡éšç§**ï¼šæ”¶é›†çš„ä¿¡æ¯ä»…ç”¨äºå­¦æœ¯å½±å“åŠ›è¯„ä¼°ï¼Œç»ä¸ä¼šè¢«åˆ†äº«ã€‚

## æ ¸å¿ƒåŠŸèƒ½

#### å›¾å½¢ç”¨æˆ·ç•Œé¢ (GUI)
åŸºäº Streamlit æ„å»ºï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å¯è§†åŒ–æ–¹å¼æ‰§è¡Œæ‰€æœ‰å·¥ä½œæµï¼Œæ— éœ€ç¼–å†™ä»£ç ã€‚
-   **å¯è§†åŒ–æ“ä½œ**ï¼šé€šè¿‡æµè§ˆå™¨å®Œå…¨æ§åˆ¶å·¥ä½œæµ
-   **å®æ—¶é¢„è§ˆ**ï¼šåº”ç”¨è§„åˆ™åå³æ—¶æŸ¥çœ‹æ•°æ®å˜åŒ–
-   **è§„åˆ™ç®¡ç†**ï¼šäº¤äº’å¼æ·»åŠ /ç§»é™¤æœ‰æ•ˆåŸå­ã€ç›å’Œæº¶å‰‚

#### åŒ–å­¦é¢„å¤„ç†ä¸æ ‡å‡†åŒ–
ä¸€ä¸ªå¯é…ç½®çš„ç®¡é“ï¼Œç”¨äºæŒ‰ç‰¹å®šã€å¯æ§çš„é¡ºåºæ¸…æ´—å’Œè§„èŒƒåŒ–åŒ–å­¦ç»“æ„ï¼š
-   **ç§»é™¤ç›**
-   **ç§»é™¤æº¶å‰‚**
-   **å¤„ç†æ··åˆç‰©**ï¼ˆä¾‹å¦‚ï¼Œä¿ç•™æœ€å¤§ç¢ç‰‡ï¼‰
-   **ç§»é™¤æ— æœºåˆ†å­**
-   **ä¸­å’Œç”µè·**
-   **éªŒè¯åŸå­ç»„æˆ**ï¼ˆåŸºäºå…è®¸çš„å…ƒç´ åˆ—è¡¨ï¼‰
-   **ç§»é™¤æ˜¾å¼æ°¢**
-   **ç§»é™¤ç«‹ä½“åŒ–å­¦ä¿¡æ¯**
-   **ç§»é™¤åŒä½ç´ **
-   **ç§»é™¤è‡ªç”±åŸº**
-   **å°†åˆ†å­æ ‡å‡†åŒ–**ä¸ºè§„èŒƒçš„SMILES
-   **æŒ‰åŸå­æ•°é‡è¿‡æ»¤**ï¼ˆé‡åŸå­æˆ–æ€»åŸå­ï¼‰

#### å•ä½æ ‡å‡†åŒ– (æ–°å¢)
-   å°†å¤šæ ·åŒ–çš„ç›®æ ‡å€¼æ ‡å‡†åŒ–ä¸ºç»Ÿä¸€å•ä½ï¼ˆä¾‹å¦‚å°†æ‰€æœ‰æ•°æ®è½¬æ¢ä¸º `mg/L`ï¼‰ã€‚
-   æ”¯æŒå¤æ‚çš„è½¬æ¢é€»è¾‘å’Œè‡ªå®šä¹‰æ•°å­¦è¡¨è¾¾å¼ã€‚

#### æ•°æ®å»é‡
-   ä¸ºé‡å¤æ¡ç›®æä¾›çµæ´»çš„å»é‡ç­–ç•¥ï¼ˆåŸºäº `smiles` æˆ–åŸºäº `continuous`/`discrete` ç›®æ ‡å€¼ï¼‰ã€‚
-   å¯è‡ªå®šä¹‰çš„åŒ¹é…æ¡ä»¶ï¼ˆå¦‚æ¸©åº¦ã€å‹å¼ºï¼‰å’Œå»é‡å¤„ç†æ–¹æ³•ï¼ˆ`auto`ã€`IQR`ã€`3sigma` æˆ–è‡ªå®šä¹‰æ–¹æ³•ï¼‰ã€‚

#### æ ‡è¯†ç¬¦ä¸å±æ€§é›†æˆï¼ˆé€šè¿‡WebæœåŠ¡ï¼‰
-   ä»å¤šä¸ªåœ¨çº¿æ•°æ®åº“ï¼ˆ**PubChemã€ChemSpiderã€CompToxã€Cactusã€CAS Common Chemistryã€ChEMBL**ï¼‰è·å–å¹¶äº’ç›¸è½¬æ¢åŒ–å­¦æ ‡è¯†ç¬¦ï¼ˆ**CASå·ã€SMILESã€IUPACåç§°ã€å¸¸ç”¨åã€åˆ†å­é‡**ï¼‰ã€‚
-   é€šè¿‡é«˜æ€§èƒ½çš„**å¹¶å‘è¯·æ±‚**åŠ é€Ÿæ•°æ®è·å–ã€‚
-   ä¸ºéœ€è¦èº«ä»½éªŒè¯çš„æœåŠ¡æä¾›é›†ä¸­çš„ API å¯†é’¥ç®¡ç†ã€‚

#### å®ç”¨å·¥å…·
-   ä½¿ç”¨ SMILES æˆ– SMARTS æ¨¡å¼æ‰§è¡Œ**äºšç»“æ„æœç´¢**ã€‚
-   **è‡ªå®šä¹‰åŒ–å­¦å¤„ç†è§„åˆ™**ï¼ŒåŒ…æ‹¬ä¸­å’Œååº”ã€ç›/æº¶å‰‚åˆ—è¡¨å’Œæœ‰æ•ˆåŸå­ã€‚
-   **æ˜¾ç¤º**å½“å‰æ‰€æœ‰ç”Ÿæ•ˆçš„å¤„ç†è§„åˆ™çš„æ‘˜è¦ã€‚

## å®‰è£…
```bash
pip install -i https://test.pypi.org/simple/ diptox
```

## å›¾å½¢ç”¨æˆ·ç•Œé¢ (GUI)
å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»ç»ˆç«¯å¯åŠ¨å›¾å½¢ç•Œé¢ï¼š
```bash
diptox-gui
```
è¯¥å‘½ä»¤å°†è‡ªåŠ¨åœ¨æ‚¨çš„é»˜è®¤ Web æµè§ˆå™¨ä¸­æ‰“å¼€ DiPTox ç•Œé¢ã€‚

## å¿«é€Ÿå…¥é—¨
```python
from diptox import DiptoxPipeline

# åˆå§‹åŒ–å¤„ç†å™¨
DP = DiptoxPipeline()

# åŠ è½½æ•°æ®ï¼ˆå¯ä»¥æ¥è‡ªæ–‡ä»¶è·¯å¾„ã€åˆ—è¡¨æˆ–DataFrameï¼‰
DP.load_data(input_data='file_path/list/dataframe', smiles_col, target_col, cas_col, unit_col)

# è‡ªå®šä¹‰å¤„ç†è§„åˆ™ï¼ˆå¯é€‰ï¼‰
print("--- é»˜è®¤è§„åˆ™ ---")
DP.display_processing_rules()

DP.manage_atom_rules(atoms=['Si'], add=True)         # å°† 'Si' æ·»åŠ åˆ°æœ‰æ•ˆåŸå­åˆ—è¡¨
DP.manage_default_salt(salts=['[Na+]'], add=False)   # ç¤ºä¾‹ï¼šä»ç›åˆ—è¡¨ä¸­ç§»é™¤é’ ç›
DP.manage_default_solvent(solvents='Cl', add=False)  # ç¤ºä¾‹ï¼šä»æº¶å‰‚åˆ—è¡¨ä¸­ç§»é™¤æ°¯
DP.add_neutralization_rule('[$([N-]C=O)]', 'N')      # æ·»åŠ ä¸€æ¡è‡ªå®šä¹‰ä¸­å’Œè§„åˆ™

print("\n--- è‡ªå®šä¹‰åçš„è§„åˆ™ ---")
DP.display_processing_rules()

# é…ç½®é¢„å¤„ç†æµç¨‹
DP.preprocess(
  remove_salts=True,          # ç§»é™¤ç›ç‰‡æ®µã€‚é»˜è®¤: Trueã€‚
  remove_solvents=True,       # ç§»é™¤æº¶å‰‚ç‰‡æ®µã€‚é»˜è®¤: Trueã€‚
  remove_mixtures=False,      # åŸºäºç‰‡æ®µå¤§å°å¤„ç†æ··åˆç‰©ã€‚é»˜è®¤: Falseã€‚
  hac_threshold=3,            # ç”¨äºç§»é™¤ç‰‡æ®µçš„é‡åŸå­æ•°é˜ˆå€¼ã€‚é»˜è®¤: 3ã€‚
  keep_largest_fragment=True, # åœ¨æ··åˆç‰©ä¸­ä¿ç•™æœ€å¤§çš„ç‰‡æ®µã€‚é»˜è®¤: Trueã€‚
  remove_inorganic=True,      # ç§»é™¤å¸¸è§çš„æ— æœºåˆ†å­ã€‚é»˜è®¤: Trueã€‚
  neutralize=True,            # ä¸­å’Œåˆ†å­ä¸Šçš„ç”µè·ã€‚é»˜è®¤: Trueã€‚
  reject_non_neutral=False,   # ä»…ä¿ç•™å½¢å¼ç”µè·ä¸ºé›¶çš„åˆ†å­ã€‚é»˜è®¤ï¼šFalseã€‚
  check_valid_atoms=False,    # æ£€æŸ¥æ‰€æœ‰åŸå­æ˜¯å¦åœ¨æœ‰æ•ˆåˆ—è¡¨ä¸­ã€‚é»˜è®¤: Falseã€‚
  strict_atom_check=False,    # è‹¥ä¸ºTrueï¼Œåˆ™ä¸¢å¼ƒå«æ— æ•ˆåŸå­çš„åˆ†å­ï¼›è‹¥ä¸ºFalseï¼Œåˆ™å°è¯•ä»æ”¯é“¾ç§»é™¤å®ƒä»¬ã€‚é»˜è®¤: Falseã€‚
  remove_stereo=False,        # ç§»é™¤ç«‹ä½“åŒ–å­¦ä¿¡æ¯ (å¦‚ @, / \)ã€‚é»˜è®¤: Falseã€‚
  remove_isotopes=True,       # ç§»é™¤åŒä½ç´ ä¿¡æ¯ (å¦‚ [13C])ã€‚é»˜è®¤: Trueã€‚
  remove_hs=True              # ç§»é™¤æ˜¾å¼çš„æ°¢åŸå­ã€‚é»˜è®¤: Trueã€‚
  reject_radical_species=True # ç§»é™¤å«æœ‰æ¸¸ç¦»åŸºåŸå­çš„åˆ†å­ã€‚é»˜è®¤ï¼šTrueã€‚
)

# é…ç½®å»é‡ä¸å•ä½æ ‡å‡†åŒ–
conversion_rules = {('g/L', 'mg/L'): 'x * 1000', 
                    ('ug/L', 'mg/L'): 'x / 1000',}
DP.config_deduplicator(condition_cols, data_type, method, custom_method, priority, standard_unit, conversion_rules, log_transform)
DP.data_deduplicate()

# é…ç½®WebæŸ¥è¯¢
DP.config_web_request(sources=['pubchem/chemspider/comptox/cactus/cas'], max_workers, ...)
DP.web_request(send='cas', request=['smiles', 'iupac'])

# äºšç»“æ„æœç´¢
DP.substructure_search(query_pattern, is_smarts=True)

# ä¿å­˜ç»“æœ
DP.save_results(output_path='file_path')

# æŸ¥çœ‹å¤„ç†å†å²
print(DP.get_history())
# Output Example:
#               Step Timestamp  Rows Before  Rows After   Delta                               Details
# 0     Data Loading  10:00:01            0        1000   +1000                   Source: dataset.csv
# 1    Preprocessing  10:00:05         1000         950     -50  Valid: 950, Invalid: 50. Order: ...
# 2    Deduplication  10:00:08          950         800    -150       Method: auto (Log10 Transformed)
```

## é«˜çº§é…ç½®

### WebæœåŠ¡é›†æˆ
DiPTox æ”¯æŒä»¥ä¸‹åŒ–å­¦æ•°æ®åº“ï¼š
-   `PubChem`: https://pubchem.ncbi.nlm.nih.gov/
-   `ChemSpider`: https://www.chemspider.com/
-   `CompTox`: https://comptox.epa.gov/dashboard/
-   `Cactus`: https://cactus.nci.nih.gov/
-   `CAS`: https://commonchemistry.cas.org/
-   `ChEMBL`: https://www.ebi.ac.uk/chembl/

**æ³¨æ„**ï¼š`ChemSpider` ã€ `CompTox` å’Œ `CAS` éœ€è¦ API å¯†é’¥ã€‚è¯·åœ¨é…ç½®æ—¶æä¾›ï¼š
```python
DP.config_web_request(
    source='chemspider/comptox',
    chemspider_api_key='your_personal_key',
    comptox_api_key='your_personal_key'
    cas_api_key='your_personal_key'
)
```
## ç¯å¢ƒè¦æ±‚
- `Python>=3.8`
- **æ ¸å¿ƒä¾èµ–**:
  - `requests`
  - `rdkit>=2023.3`
  - `tqdm`
  - `openpyxl`
  - `scipy`
  - `streamlit>=1.0.0` (è¿è¡Œ GUI æ‰€éœ€)
- **å¯é€‰ä¾èµ–** (æ ¹æ®éœ€è¦å®‰è£…ï¼Œå¦‚ä¸å®‰è£…åˆ™ä½¿ç”¨`requests`å‘é€è¯·æ±‚):
  - `pubchempy>=1.0.5`: ç”¨äº PubChem é›†æˆ
  - `chemspipy>=2.0.0`: ç”¨äº ChemSpider é›†æˆ (éœ€è¦ API å¯†é’¥)
  - `ctx-python>=0.0.1a10`: ç”¨äº CompTox Dashboard é›†æˆ (éœ€è¦ API å¯†é’¥)

## è®¸å¯è¯
æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## æ”¯æŒ
å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/Hya0FAD/DiPTox/issues) ä¸Šæäº¤ã€‚
